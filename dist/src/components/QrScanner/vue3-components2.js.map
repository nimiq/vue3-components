{"version":3,"file":"vue3-components2.js","sources":["../../../../src/components/QrScanner/QrScanner.vue"],"sourcesContent":["<template>\n    <div class=\"qr-scanner nq-blue-bg\" ref=\"root$\">\n        <video ref=\"video$\" muted autoplay playsinline width=\"600\" height=\"600\"></video>\n        <div ref=\"overlay$\" class=\"overlay\" :class=\"{ inactive: cameraAccessFailed }\">\n            <slot>\n                <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 238 238\">\n                    <path fill=\"none\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"4\" d=\"M31.3 2H10a8 8 0 0 0-8 8v21.3M206.8 2H228a8 8 0 0 1 8 8v21.3m0 175.4V228a8 8 0 0 1-8 8h-21.3m-175.4 0H10a8 8 0 0 1-8-8v-21.3\"/>\n                </svg>\n            </slot>\n        </div>\n        <button class=\"nq-button-s inverse cancel-button\" @click=\"cancel\">{{ $t('Cancel') }}</button>\n\n        <transition name=\"fade\">\n            <div v-if=\"cameraAccessFailed\" class=\"camera-access-failed\">\n                <div v-if=\"!hasCamera\" class=\"camera-access-failed-warning\">\n                    {{ $t('Your device does not have an accessible camera.') }}\n                </div>\n                <div v-else>\n                    <div class=\"camera-access-failed-warning\">\n                        {{ $t('Unblock the camera for this website to scan QR codes.') }}\n                    </div>\n                    <div v-if=\"isMobileOrTablet\">\n                        <div v-if=\"browser === 'chrome'\">\n                            <I18n path=\"Click on {icon} and go to\\nSettings > Site Settings > Camera\"\n                                tag=\"div\" componentName=\"QrScanner\"\n                                class=\"access-denied-instructions\">\n                                <template #icon>\n                                    <span class=\"browser-menu-icon\"></span>\n                                </template>\n                            </I18n>\n                            <div class=\"browser-menu-arrow\"></div>\n                        </div>\n                        <div v-else class=\"access-denied-instructions\">\n                            <!-- Mobile safari and mobile firefox ask on every camera request -->\n                            {{ $t('Grant camera access when asked.') }}\n                        </div>\n                    </div>\n                    <div v-else class=\"access-denied-instructions\">\n                        <I18n v-if=\"browser === 'safari'\"\n                            path=\"Click on {safari} and go to\\nSettings for this Website > Camera\"\n                            tag=\"div\" componentName=\"QrScanner\">\n                            <template #safari>\n                                <b>Safari</b>\n                            </template>\n                        </I18n>\n                        <I18n v-else path=\"Click on {icon} in the URL bar.\"\n                            tag=\"div\" componentName=\"QrScanner\">\n                            <template #icon>\n                                <span v-if=\"browser === 'chrome'\" class=\"camera-icon-chrome\"></span>\n                                <span v-else-if=\"browser === 'firefox'\" class=\"camera-icon-firefox\"></span>\n                                <span v-else>{{ $t('the camera icon') }}</span>\n                            </template>\n                        </I18n>\n                    </div>\n                </div>\n            </div>\n        </transition>\n    </div>\n</template>\n\n<script lang=\"ts\">\n// TODO could use IntersectionObserver api to start scanner when visible\n\nimport { defineComponent, onMounted, onUnmounted, PropType, ref } from 'vue';\nimport QrScannerLib from 'qr-scanner';\nimport { BrowserDetection } from '@nimiq/utils';\nimport I18n from '../../i18n/I18n';\nimport { loadI18n } from '../../i18n/I18nComposable';\n\nexport const enum QrScannerEvents {\n    RESULT = 'result',\n    CANCEL = 'cancel',\n    ERROR = 'error',\n}\n\nexport default defineComponent({\n    name: 'QrScanner',\n    props: {\n        reportFrequency: {\n            type: Number,\n            default: 7000\n        },\n        validate: Function as PropType<(scanResult: string) => boolean>,\n    },\n    methods: { $t: loadI18n('QrScanner') },\n    setup(props, context) {\n        const root$ = ref<HTMLDivElement | null>(null);\n        const video$ = ref<HTMLVideoElement | null>(null);\n        const overlay$ = ref<HTMLDivElement | null>(null);\n\n        const cameraAccessFailed = ref(false);\n        const hasCamera = ref(true);\n\n        const isMobileOrTablet: boolean = BrowserDetection.isMobile();\n        const browser: BrowserDetection.Browser = BrowserDetection.detectBrowser();\n\n        let scanner: QrScannerLib | null = null;\n        let lastResult: string = '';\n        let lastResultTime: number = 0;\n        let cameraRetryTimer: number | null = null;\n\n        onMounted(async () => {\n            // @ts-ignore-next-line\n            // QrScannerLib._disableBarcodeDetector = true;\n\n            scanner = new QrScannerLib(video$.value!, (result) => onResult(result), {});\n            video$.value!.addEventListener('canplay', () => video$.value!.classList.add('ready'));\n            window.addEventListener('resize', repositionOverlay);\n\n            QrScannerLib.hasCamera().then((newHasCamera) => hasCamera.value = newHasCamera);\n\n            if (isVisible()) {\n                start();\n                repositionOverlay();\n            }\n        });\n\n        onUnmounted(() => {\n            stop();\n            if (scanner) scanner.destroy();\n            window.removeEventListener('resize', repositionOverlay);\n        })\n\n        async function start() {\n            try {\n                await scanner!.start();\n                cameraAccessFailed.value = false;\n                if (cameraRetryTimer) {\n                    window.clearInterval(cameraRetryTimer);\n                    cameraRetryTimer = null;\n                }\n            } catch (e) {\n                cameraAccessFailed.value = true;\n                context.emit(QrScannerEvents.ERROR, e);\n                if (!cameraRetryTimer) {\n                    cameraRetryTimer = window.setInterval(() => start(), 3000);\n                }\n            }\n            return !cameraAccessFailed.value;\n        }\n\n        function stop() {\n            if (!scanner) return;\n            scanner.stop();\n            if (cameraRetryTimer) {\n                window.clearInterval(cameraRetryTimer);\n                cameraRetryTimer = null;\n            }\n        }\n\n        function setGrayscaleWeights(red: number, green: number, blue: number) {\n            if (scanner) scanner.setGrayscaleWeights(red, green, blue);\n        }\n\n        function setInversionMode(inversionMode: QrScannerLib.InversionMode) {\n            if (scanner) scanner.setInversionMode(inversionMode);\n        }\n\n        function repositionOverlay() {\n            requestAnimationFrame(() => {\n                if (!root$.value || !overlay$.value) return;\n\n                const scannerHeight = root$.value.offsetHeight;\n                const scannerWidth = root$.value.offsetWidth;\n                const smallerDimension = Math.min(scannerHeight, scannerWidth);\n                if (smallerDimension === 0) return; // component not visible or destroyed\n                const overlaySize = Math.ceil(2 / 3 * smallerDimension);\n                // not always the accurate size of the sourceRect for QR detection in QrScannerLib (e.g. if video is\n                // landscape and screen portrait) but looks nicer in the UI.\n                overlay$.value.style.width = overlaySize + 'px';\n                overlay$.value.style.height = overlaySize + 'px';\n                overlay$.value.style.top = ((scannerHeight - overlaySize) / 2) + 'px';\n                overlay$.value.style.left = ((scannerWidth - overlaySize) / 2) + 'px';\n            });\n        }\n\n        function isVisible() {\n            return !!root$.value && root$.value.offsetWidth > 0;\n        }\n\n        function cancel() {\n            context.emit(QrScannerEvents.CANCEL);\n        }\n\n        function onResult(result: QrScannerLib.ScanResult) {\n            if ((result.data === lastResult && Date.now() - lastResultTime < props.reportFrequency)\n                || (props.validate && !props.validate(result.data))) return;\n            lastResult = result.data;\n            lastResultTime = Date.now();\n            context.emit(QrScannerEvents.RESULT, result);\n        }\n\n        context.expose({\n            start,\n            stop,\n            setGrayscaleWeights,\n            setInversionMode,\n            repositionOverlay,\n        });\n\n        return {\n            root$,\n            video$,\n            overlay$,\n\n            cameraAccessFailed,\n            hasCamera,\n\n            isMobileOrTablet,\n            browser,\n\n            cancel,\n        };\n    },\n    components: { I18n },\n})\n</script>\n\n<style scoped>\n    .qr-scanner {\n        position: relative;\n        overflow: hidden;\n    }\n\n    .fade-enter,\n    .fade-leave-to {\n        opacity: 0;\n        transition: .7s;\n    }\n\n    .fade-leave,\n    .fade-enter-to {\n        opacity: 1;\n        transition: .7s;\n    }\n\n    video {\n        position: absolute;\n        left: 0;\n        top: 0;\n        height: 100%;\n        width: 100%;\n        object-fit: cover;\n        display: block;\n        opacity: 0;\n        transition: opacity .3s;\n    }\n\n    video.ready {\n        opacity: 1;\n    }\n\n    .overlay {\n        position: absolute;\n    }\n\n    .overlay:not(.inactive) {\n        animation: overlay-animation 400ms infinite alternate ease-in-out;\n    }\n\n    @keyframes overlay-animation {\n        from {\n            transform: scale(.98);\n        }\n        to {\n            transform: scale(1.01);\n        }\n    }\n\n    .overlay svg {\n        width: 100%;\n        height: 100%;\n        stroke: var(--nimiq-gold);\n    }\n\n    .overlay.inactive svg {\n        stroke: rgba(255, 255, 255, .4);\n    }\n\n    .cancel-button {\n        background: white;\n        position: absolute;\n        bottom: 3rem;\n        left: 50%;\n        transform: translateX(-50%);\n        color: var(--nimiq-blue);\n    }\n\n    .cancel-button:hover,\n    .cancel-button:focus,\n    .cancel-button:active {\n        background: #EFF0F2; /* Indigo 7% */\n    }\n\n    .camera-access-failed {\n        color: white;\n        text-align: center;\n        font-size: 2rem;\n    }\n\n    .camera-access-failed-warning {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        width: 30rem;\n        max-width: 80%;\n        font-weight: bold;\n    }\n\n    .access-denied-instructions {\n        opacity: .7;\n        position: absolute;\n        left: 50%;\n        bottom: 9rem;\n        width: calc(100% - 4rem);\n        transform: translateX(-50%);\n        line-height: 1.7;\n        white-space: pre-line;\n    }\n\n    .browser-menu-icon,\n    .camera-icon-chrome,\n    .camera-icon-firefox {\n        display: inline-block;\n        background-repeat: no-repeat;\n        margin: 0 .2em;\n        position: relative;\n        top: .2em;\n    }\n\n    .browser-menu-icon {\n        background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"white\" viewBox=\"0 0 3 15\"><circle cx=\"1.5\" cy=\"1.5\" r=\"1.5\"/><circle cx=\"1.5\" cy=\"7.5\" r=\"1.5\"/><circle cx=\"1.5\" cy=\"13.5\" r=\"1.5\"/></svg>');\n        height: 1em;\n        width: calc(1em * (3 / 15));\n    }\n\n    .camera-icon-chrome {\n        background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 14 12\"><path fill=\"%23FF5C48\" fill-rule=\"evenodd\" d=\"M7.8 5h5.4c.4 0 .8.4.8.8v5.4c0 .4-.4.8-.9.8H7.8c-.4 0-.8-.4-.8-.9V5.8c0-.4.4-.8.8-.8zm4.04 4.85c.2-.2.2-.5 0-.7l-.64-.65.65-.65c.2-.2.2-.5 0-.7a.5.5 0 0 0-.7 0l-.66.64-.63-.64a.5.5 0 0 0-.71 0c-.2.2-.2.5 0 .7l.64.65-.64.65c-.2.2-.2.5 0 .7a.48.48 0 0 0 .7 0l.64-.64.65.64a.48.48 0 0 0 .7 0z\" clip-rule=\"evenodd\"/><path fill=\"white\" d=\"M6 5.8C6 4.8 6.8 4 7.8 4H12V.5L9.5 3V.5C9.5.2 9.3 0 9 0H.5C.2 0 0 .2 0 .5v7c0 .3.2.5.5.5H6V5.8z\"/></svg>');\n        height: .8em;\n        width: calc(.8em * (14 / 12));\n    }\n\n    .camera-icon-firefox {\n        background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"white\" viewBox=\"0 0 14 14\"><path d=\"M13.5.3c-.4-.4-.9-.4-1.3 0L9.7 2.8c-.1-.5-.5-.9-1-.9H1c-.6 0-1 .4-1 1v7.7c0 .5.4.9.9 1l-.6.6c-.4.4-.4.9 0 1.3l.6.3c.2 0 .5-.1.6-.3l12-12a1 1 0 0 0 0-1.2zM13.7 11.6V3.5l-4 4.1 4 4zM8.7 11.6c.6 0 1-.4 1-1v-3l-4 4h3z\"/></svg>');\n        height: .9em;\n        width: .9em;\n    }\n\n    .browser-menu-arrow {\n        background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 18 23\"><path stroke=\"%230CA6FE\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 22V3M2 9l7-7 7 7\"/></svg>');\n        animation: arrow-bounce 400ms infinite alternate ease-in-out;\n        position: fixed;\n        top: 3rem;\n        right: 2.2rem;\n        width: 2rem;\n        height: calc(2rem / (18 / 23)); /* calculate from aspect ratio and width */\n    }\n\n    @keyframes arrow-bounce {\n        to {\n            transform: translateY(-1rem);\n        }\n    }\n</style>\n"],"names":["_sfc_main","defineComponent","loadI18n","props","context","root$","ref","video$","overlay$","cameraAccessFailed","hasCamera","isMobileOrTablet","BrowserDetection","browser","scanner","lastResult","lastResultTime","cameraRetryTimer","onMounted","QrScannerLib","result","onResult","repositionOverlay","newHasCamera","isVisible","start","onUnmounted","stop","setGrayscaleWeights","red","green","blue","setInversionMode","inversionMode","scannerHeight","scannerWidth","smallerDimension","overlaySize","cancel","I18n"],"mappings":"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"}